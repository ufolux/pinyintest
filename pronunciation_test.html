<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å‘éŸ³æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        backdrop-filter: blur(10px);
      }
      .test-item {
        margin: 10px 0;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      button {
        padding: 8px 16px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background: #45a049;
      }
      .result {
        flex: 1;
        padding: 8px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
      }
      .debug {
        font-size: 12px;
        color: #ccc;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ”Š æ‹¼éŸ³å‘éŸ³æµ‹è¯•å·¥å…·</h1>

    <div class="test-section">
      <h2>åŸºç¡€æ‹¼éŸ³å‘éŸ³æµ‹è¯•</h2>
      <div id="basic-tests"></div>
      <button onclick="runBasicTests()">è¿è¡ŒåŸºç¡€æµ‹è¯•</button>
    </div>

    <div class="test-section">
      <h2>å£°è°ƒå‘éŸ³æµ‹è¯•</h2>
      <div id="tone-tests"></div>
      <button onclick="runToneTests()">è¿è¡Œå£°è°ƒæµ‹è¯•</button>
    </div>

    <div class="test-section">
      <h2>è‡ªå®šä¹‰æµ‹è¯•</h2>
      <input
        type="text"
        id="custom-shengmu"
        placeholder="å£°æ¯"
        style="padding: 8px; margin: 5px"
      />
      <input
        type="text"
        id="custom-yunmu"
        placeholder="éŸµæ¯"
        style="padding: 8px; margin: 5px"
      />
      <select id="custom-tone" style="padding: 8px; margin: 5px">
        <option value="1">ä¸€å£°</option>
        <option value="2">äºŒå£°</option>
        <option value="3">ä¸‰å£°</option>
        <option value="4">å››å£°</option>
        <option value="0">è½»å£°</option>
      </select>
      <button onclick="testCustom()">æµ‹è¯•å‘éŸ³</button>
      <div id="custom-result"></div>
    </div>

    <script>
      // å¤åˆ¶ä¸»è¦çš„å‘éŸ³å‡½æ•°
      function getCharacterForPronunciation(shengmu, yunmu, tone) {
        // ç®€åŒ–çš„æ±‰å­—æ˜ å°„
        const pinyinCharacterMap = {
          ba1: "å…«",
          ba2: "æ‹”",
          ba3: "æŠŠ",
          ba4: "çˆ¸",
          ba0: "å§",
          ma1: "å¦ˆ",
          ma2: "éº»",
          ma3: "é©¬",
          ma4: "éª‚",
          ma0: "å—",
          da1: "æ­",
          da2: "è¾¾",
          da3: "æ‰“",
          da4: "å¤§",
          da0: "å¤§",
          ta1: "ä»–",
          ta2: "è¸",
          ta3: "å¡”",
          ta4: "è¸",
          ta0: "ä»–",
          na1: "æ‹¿",
          na2: "æ‹¿",
          na3: "å“ª",
          na4: "é‚£",
          na0: "å“ª",
          la1: "æ‹‰",
          la2: "æ¥",
          la3: "è€",
          la4: "è¾£",
          la0: "å•¦",
        };

        const pinyinKey = shengmu + yunmu + (tone || 1);
        if (pinyinCharacterMap[pinyinKey]) {
          return pinyinCharacterMap[pinyinKey];
        }

        const fallbackKey = shengmu + yunmu + "1";
        if (pinyinCharacterMap[fallbackKey]) {
          return pinyinCharacterMap[fallbackKey];
        }

        return findCommonCharacterByPinyin(shengmu + yunmu, tone);
      }

      function findCommonCharacterByPinyin(pinyinText, tone) {
        const commonChars = {
          ba: ["å…«", "æ‹”", "æŠŠ", "çˆ¸", "å§"],
          ma: ["å¦ˆ", "éº»", "é©¬", "éª‚", "å—"],
          da: ["æ­", "è¾¾", "æ‰“", "å¤§", "å¤§"],
          ta: ["ä»–", "è¸", "å¡”", "è¸", "ä»–"],
          na: ["æ‹¿", "æ‹¿", "å“ª", "é‚£", "å“ª"],
          la: ["æ‹‰", "æ¥", "è€", "è¾£", "å•¦"],
          di: ["æ»´", "æ•Œ", "åº•", "åœ°", "åœ°"],
          ti: ["è¸¢", "æ", "ä½“", "æ›¿", "æ"],
          ni: ["å°¼", "æ³¥", "ä½ ", "é€†", "ä½ "],
          li: ["ç¦»", "æ¢¨", "é‡Œ", "åŠ›", "é‡Œ"],
        };

        if (commonChars[pinyinText] && commonChars[pinyinText].length > 0) {
          const chars = commonChars[pinyinText];
          if (tone && tone >= 1 && tone <= 4 && chars[tone - 1]) {
            return chars[tone - 1];
          }
          if (tone === 0 && chars[4]) {
            return chars[4];
          }
          return chars[0];
        }
        return null;
      }

      function playPronunciation(character, debug = false) {
        if (!character) {
          alert("æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å‘éŸ³");
          return;
        }

        if ("speechSynthesis" in window) {
          speechSynthesis.cancel();

          const utterance = new SpeechSynthesisUtterance();
          utterance.text = character;
          utterance.lang = "zh-CN";
          utterance.rate = 0.6;
          utterance.pitch = 1.0;
          utterance.volume = 1.0;

          function selectVoiceAndSpeak() {
            const voices = speechSynthesis.getVoices();
            const chineseVoices = voices.filter(
              (voice) =>
                voice.lang.includes("zh") ||
                voice.lang.includes("CN") ||
                voice.name.includes("Chinese") ||
                voice.name.includes("ä¸­æ–‡") ||
                voice.name.includes("Mandarin")
            );

            if (chineseVoices.length > 0) {
              utterance.voice = chineseVoices[0];
              if (debug) console.log("é€‰æ‹©è¯­éŸ³:", utterance.voice.name);
            }

            utterance.onstart = () => {
              if (debug) console.log("å¼€å§‹æ’­æ”¾:", character);
            };

            utterance.onerror = (event) => {
              console.error("è¯­éŸ³æ’­æ”¾é”™è¯¯:", event);
              alert("è¯­éŸ³æ’­æ”¾å¤±è´¥");
            };

            speechSynthesis.speak(utterance);
          }

          if (speechSynthesis.getVoices().length === 0) {
            speechSynthesis.onvoiceschanged = selectVoiceAndSpeak;
          } else {
            selectVoiceAndSpeak();
          }
        } else {
          alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æ’­æ”¾åŠŸèƒ½");
        }
      }

      function runBasicTests() {
        const basicTests = [
          ["b", "a"],
          ["p", "a"],
          ["m", "a"],
          ["d", "a"],
          ["t", "a"],
          ["n", "a"],
          ["l", "a"],
          ["d", "i"],
          ["t", "i"],
          ["n", "i"],
          ["l", "i"],
        ];

        const container = document.getElementById("basic-tests");
        container.innerHTML = "";

        basicTests.forEach(([shengmu, yunmu]) => {
          const character = getCharacterForPronunciation(shengmu, yunmu, 1);
          const div = document.createElement("div");
          div.className = "test-item";
          div.innerHTML = `
                    <button onclick="playPronunciation('${character}', true)">ğŸ”Š</button>
                    <div class="result">
                        <strong>${shengmu} + ${yunmu}</strong> â†’ ${
            character || "æ— å‘éŸ³"
          }
                        <div class="debug">æ‹¼éŸ³: ${shengmu}${yunmu}</div>
                    </div>
                `;
          container.appendChild(div);
        });
      }

      function runToneTests() {
        const toneTests = [
          ["m", "a", 1],
          ["m", "a", 2],
          ["m", "a", 3],
          ["m", "a", 4],
          ["d", "a", 1],
          ["d", "a", 2],
          ["d", "a", 3],
          ["d", "a", 4],
        ];

        const container = document.getElementById("tone-tests");
        container.innerHTML = "";

        toneTests.forEach(([shengmu, yunmu, tone]) => {
          const character = getCharacterForPronunciation(shengmu, yunmu, tone);
          const toneNames = {
            1: "ä¸€å£°",
            2: "äºŒå£°",
            3: "ä¸‰å£°",
            4: "å››å£°",
            0: "è½»å£°",
          };
          const div = document.createElement("div");
          div.className = "test-item";
          div.innerHTML = `
                    <button onclick="playPronunciation('${character}', true)">ğŸ”Š</button>
                    <div class="result">
                        <strong>${shengmu} + ${yunmu} (${
            toneNames[tone]
          })</strong> â†’ ${character || "æ— å‘éŸ³"}
                        <div class="debug">å£°è°ƒ: ç¬¬${tone}å£°</div>
                    </div>
                `;
          container.appendChild(div);
        });
      }

      function testCustom() {
        const shengmu = document.getElementById("custom-shengmu").value.trim();
        const yunmu = document.getElementById("custom-yunmu").value.trim();
        const tone = parseInt(document.getElementById("custom-tone").value);

        if (!shengmu || !yunmu) {
          alert("è¯·è¾“å…¥å£°æ¯å’ŒéŸµæ¯");
          return;
        }

        const character = getCharacterForPronunciation(shengmu, yunmu, tone);
        const toneNames = {
          1: "ä¸€å£°",
          2: "äºŒå£°",
          3: "ä¸‰å£°",
          4: "å››å£°",
          0: "è½»å£°",
        };

        const container = document.getElementById("custom-result");
        container.innerHTML = `
                <div class="test-item">
                    <button onclick="playPronunciation('${character}', true)">ğŸ”Š</button>
                    <div class="result">
                        <strong>${shengmu} + ${yunmu} (${
          toneNames[tone]
        })</strong> â†’ ${character || "æ— å‘éŸ³"}
                        <div class="debug">å®Œæ•´æ‹¼éŸ³: ${shengmu}${yunmu}${tone}</div>
                    </div>
                </div>
            `;

        if (character) {
          playPronunciation(character, true);
        }
      }

      // é¡µé¢åŠ è½½å®Œæˆåè¿è¡ŒåŸºç¡€æµ‹è¯•
      window.onload = function () {
        runBasicTests();
      };
    </script>
  </body>
</html>
