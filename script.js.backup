// å®Œæ•´çš„æ‹¼éŸ³ç»„åˆéªŒè¯è¡¨ - åŸºäºæ ‡å‡†æ‹¼éŸ³è§„åˆ™
const PINYIN_VALIDATION_TABLE = (() => {
  const master = [
    "",
    "b",
    "p",
    "m",
    "f",
    "d",
    "t",
    "n",
    "l",
    "g",
    "k",
    "h",
    "j",
    "q",
    "x",
    "z",
    "c",
    "s",
    "zh",
    "ch",
    "sh",
    "r",
    "y",
    "w",
  ];
  const slave = [
    "a",
    "o",
    "e",
    "i",
    "u",
    "Ã¼",
    "ai",
    "ao",
    "an",
    "ang",
    "ou",
    "ong",
    "ei",
    "er",
    "en",
    "eng",
    "iu",
    "ie",
    "in",
    "ing",
    "ia",
    "iao",
    "ian",
    "iang",
    "iong",
    "ui",
    "un",
    "ua",
    "uai",
    "uan",
    "uang",
    "uo",
    "Ã¼e",
  ];

  const table = [
    "111111111111000111111011", // a
    "111110000000000000000011", // o
    "100101111111000111111110", // e
    "011101111000111111111110", // i
    "011111111111000111111101", // u
    "000000000000111000000010", // Ã¼
    "111101111111000111111001", // ai
    "111101111111000111111110", // ao
    "111111111111000111111111", // an
    "111111111111000111111111", // ang
    "111111111111000111111111", // ou
    "101111111111000111111110", // ong
    "000001111111000111110110", // ei
    "111111111111000110101001", // er
    "100000000000000000000000", // en
    "111111010111000111111101", // eng
    "111111111111000111111101", // iu
    "000101011000111000000000", // ie
    "011101111000111000000000", // in
    "011100011000111000000010", // ing
    "011101111000111000000010", // ia
    "000001001000111000000000", // iao
    "011101111000111000000000", // ian
    "011101111000111000000000", // iang
    "000000011000111000000000", // iong
    "000000000000111000000000", // ui
    "000001100111000111111100", // un
    "000001111111111111111100", // ua
    "000000000111000000111100", // uai
    "000000000111000000111000", // uan
    "000001111111111111111110", // uang
    "000000000111000000111000", // uo
    "000001111111000111111100", // Ã¼e
  ];

  const validCombinations = new Set();

  for (let i = 0; i < slave.length; i++) {
    for (let j = 0; j < master.length; j++) {
      if (table[i][j] === "1") {
        const combination = master[j] + slave[i];
        validCombinations.add(combination);
      }
    }
  }

  return validCombinations;
})();

// æ‹¼éŸ³ç»„åˆéªŒè¯å‡½æ•° - ä½¿ç”¨å®Œæ•´éªŒè¯è¡¨
function isValidCombination(shengmu, yunmu) {
  // å¤„ç†ç©ºå£°æ¯çš„æƒ…å†µ
  const shengmuToCheck = shengmu || "";
  const combination = shengmuToCheck + yunmu;

  return PINYIN_VALIDATION_TABLE.has(combination);
}

// æ‹¼éŸ³æ•°æ®
const pinyinData = {
  // å£°æ¯ (ä¸åŒ…æ‹¬é›¶å£°æ¯)
  shengmu: [
    "b",
    "p",
    "m",
    "f",
    "d",
    "t",
    "n",
    "l",
    "g",
    "k",
    "h",
    "j",
    "q",
    "x",
    "zh",
    "ch",
    "sh",
    "r",
    "z",
    "c",
    "s",
  ],

  // éŸµæ¯ (æŒ‰ç…§æ‹¼éŸ³éªŒè¯è¡¨çš„é¡ºåº)
  yunmu: [
    "a",
    "o",
    "e",
    "i",
    "u",
    "Ã¼",
    "ai",
    "ao",
    "an",
    "ang",
    "ou",
    "ong",
    "ei",
    "er",
    "en",
    "eng",
    "iu",
    "ie",
    "in",
    "ing",
    "ia",
    "iao",
    "ian",
    "iang",
    "iong",
    "ui",
    "un",
    "ua",
    "uai",
    "uan",
    "uang",
    "uo",
    "Ã¼e",
  ],

  // å£°è°ƒ
  shengdiao: [
    { tone: 1, name: "ä¸€å£°", symbol: "Ë‰" },
    { tone: 2, name: "äºŒå£°", symbol: "ËŠ" },
    { tone: 3, name: "ä¸‰å£°", symbol: "Ë‡" },
    { tone: 4, name: "å››å£°", symbol: "Ë‹" },
    { tone: 0, name: "è½»å£°", symbol: "" },
  ],
};

// æ‹¼éŸ³è§„åˆ™ - å®šä¹‰å“ªäº›å£°æ¯å’ŒéŸµæ¯å¯ä»¥ç»„åˆ
const pinyinRules = {
  // çœŸæ­£ä¸èƒ½ç»„åˆçš„å£°æ¯å’ŒéŸµæ¯ï¼ˆåŸºäºæ ‡å‡†æ±‰è¯­æ‹¼éŸ³è§„åˆ™ï¼‰
  invalidCombinations: [
    // j, q, x åªèƒ½ä¸ i, Ã¼ å¼€å¤´çš„éŸµæ¯ç»„åˆï¼Œä¸èƒ½ä¸å…¶ä»–éŸµæ¯ç»„åˆ
    ["j", "a"],
    ["j", "o"],
    ["j", "u"],
    ["j", "ai"],
    ["j", "ao"],
    ["j", "ou"],
    ["j", "an"],
    ["j", "un"],
    ["j", "ang"],
    ["j", "ong"],
    ["q", "a"],
    ["q", "o"],
    ["q", "u"],
    ["q", "ai"],
    ["q", "ao"],
    ["q", "ou"],
    ["q", "an"],
    ["q", "un"],
    ["q", "ang"],
    ["q", "ong"],
    ["x", "a"],
    ["x", "o"],
    ["x", "u"],
    ["x", "ai"],
    ["x", "ao"],
    ["x", "ou"],
    ["x", "an"],
    ["x", "un"],
    ["x", "ang"],
    ["x", "ong"],

    // zh, ch, sh, r ä¸èƒ½ä¸ i, Ã¼ å¼€å¤´çš„éŸµæ¯ç»„åˆ
    ["zh", "i"],
    ["zh", "Ã¼"],
    ["zh", "ie"],
    ["zh", "Ã¼e"],
    ["zh", "in"],
    ["zh", "Ã¼n"],
    ["ch", "i"],
    ["ch", "Ã¼"],
    ["ch", "ie"],
    ["ch", "Ã¼e"],
    ["ch", "in"],
    ["ch", "Ã¼n"],
    ["sh", "i"],
    ["sh", "Ã¼"],
    ["sh", "ie"],
    ["sh", "Ã¼e"],
    ["sh", "in"],
    ["sh", "Ã¼n"],
    ["r", "i"],
    ["r", "Ã¼"],
    ["r", "ie"],
    ["r", "Ã¼e"],
    ["r", "in"],
    ["r", "Ã¼n"],

    // z, c, s ä¸èƒ½ä¸ Ã¼ å¼€å¤´çš„éŸµæ¯ç»„åˆ
    ["z", "Ã¼"],
    ["z", "Ã¼e"],
    ["z", "Ã¼n"],
    ["c", "Ã¼"],
    ["c", "Ã¼e"],
    ["c", "Ã¼n"],
    ["s", "Ã¼"],
    ["s", "Ã¼e"],
    ["s", "Ã¼n"],

    // b, p, m, f ä¸èƒ½ä¸ Ã¼ å¼€å¤´çš„éŸµæ¯ç»„åˆ
    ["b", "Ã¼"],
    ["b", "Ã¼e"],
    ["b", "Ã¼n"],
    ["p", "Ã¼"],
    ["p", "Ã¼e"],
    ["p", "Ã¼n"],
    ["m", "Ã¼"],
    ["m", "Ã¼e"],
    ["m", "Ã¼n"],
    ["f", "Ã¼"],
    ["f", "Ã¼e"],
    ["f", "Ã¼n"],

    // d, t, n, l ä¸èƒ½ä¸ Ã¼ å¼€å¤´çš„éŸµæ¯ç»„åˆ
    ["d", "Ã¼"],
    ["d", "Ã¼e"],
    ["d", "Ã¼n"],
    ["t", "Ã¼"],
    ["t", "Ã¼e"],
    ["t", "Ã¼n"],
    ["n", "Ã¼"],
    ["n", "Ã¼e"],
    ["n", "Ã¼n"],
    ["l", "Ã¼"],
    ["l", "Ã¼e"],
    ["l", "Ã¼n"],

    // g, k, h ä¸èƒ½ä¸ i, Ã¼ å¼€å¤´çš„éŸµæ¯ç»„åˆ
    ["g", "i"],
    ["g", "Ã¼"],
    ["g", "ie"],
    ["g", "Ã¼e"],
    ["g", "in"],
    ["g", "Ã¼n"],
    ["k", "i"],
    ["k", "Ã¼"],
    ["k", "ie"],
    ["k", "Ã¼e"],
    ["k", "in"],
    ["k", "Ã¼n"],
    ["h", "i"],
    ["h", "Ã¼"],
    ["h", "ie"],
    ["h", "Ã¼e"],
    ["h", "in"],
    ["h", "Ã¼n"],
  ],
};

// å½“å‰é€‰æ‹©çš„æ‹¼éŸ³ç»„åˆ
let currentSelection = {
  shengmu: null,
  yunmu: null,
  shengdiao: null,
};

// DOM å…ƒç´ 
let elements = {};

// åˆå§‹åŒ–
document.addEventListener("DOMContentLoaded", function () {
  initializeElements();
  generateButtons();
  bindEvents();

  // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œæµ‹è¯•
  console.log("=== æ‹¼éŸ³éªŒè¯æµ‹è¯• ===");

  // æµ‹è¯•æœ‰æ•ˆç»„åˆ
  console.log("æœ‰æ•ˆç»„åˆæµ‹è¯•:");
  console.log("ba:", isValidCombination("b", "a")); // åº”è¯¥æ˜¯ true
  console.log("ma:", isValidCombination("m", "a")); // åº”è¯¥æ˜¯ true
  console.log("zhang:", isValidCombination("zh", "ang")); // åº”è¯¥æ˜¯ true
  console.log("zi:", isValidCombination("z", "i")); // åº”è¯¥æ˜¯ true

  // æµ‹è¯•æ— æ•ˆç»„åˆ
  console.log("æ— æ•ˆç»„åˆæµ‹è¯•:");
  console.log("j + a:", isValidCombination("j", "a")); // åº”è¯¥æ˜¯ false
  console.log("zh + i:", isValidCombination("zh", "i")); // åº”è¯¥æ˜¯ false
  console.log("z + Ã¼:", isValidCombination("z", "Ã¼")); // åº”è¯¥æ˜¯ false

  // æµ‹è¯•é›¶å£°æ¯ç»„åˆ
  console.log("é›¶å£°æ¯ç»„åˆæµ‹è¯•:");
  console.log("a:", isValidCombination("", "a")); // åº”è¯¥æ˜¯ true
  console.log("o:", isValidCombination("", "o")); // åº”è¯¥æ˜¯ true
  console.log("e:", isValidCombination("", "e")); // åº”è¯¥æ˜¯ true

  console.log("éªŒè¯è¡¨ä¸­æ€»å…±æœ‰", PINYIN_VALIDATION_TABLE.size, "ä¸ªæœ‰æ•ˆç»„åˆ");
  console.log("=== æµ‹è¯•å®Œæˆ ===");
});

function initializeElements() {
  elements = {
    currentShengmu: document.getElementById("current-shengmu"),
    currentYunmu: document.getElementById("current-yunmu"),
    currentShengdiao: document.getElementById("current-shengdiao"),
    pinyinResult: document.getElementById("pinyin-result"),
    playButton: document.getElementById("play-button"),
    errorMessage: document.getElementById("error-message"),
    shengmuGrid: document.getElementById("shengmu-grid"),
    yunmuGrid: document.getElementById("yunmu-grid"),
    shengdiaoGrid: document.getElementById("shengdiao-grid"),
    clearButton: document.getElementById("clear-button"),
    randomButton: document.getElementById("random-button"),
  };
}

function generateButtons() {
  generateShengmuButtons();
  generateYunmuButtons();
  generateShengdiaoButtons();
}

function generateShengmuButtons() {
  elements.shengmuGrid.innerHTML = "";
  pinyinData.shengmu.forEach((shengmu) => {
    const button = document.createElement("button");
    button.className = "selection-button shengmu-button";
    button.textContent = shengmu;
    button.onclick = () => selectShengmu(shengmu, button);
    elements.shengmuGrid.appendChild(button);
  });
}

function generateYunmuButtons() {
  elements.yunmuGrid.innerHTML = "";
  pinyinData.yunmu.forEach((yunmu) => {
    const button = document.createElement("button");
    button.className = "selection-button yunmu-button";
    button.textContent = yunmu;
    button.onclick = () => selectYunmu(yunmu, button);
    elements.yunmuGrid.appendChild(button);
  });
}

function generateShengdiaoButtons() {
  elements.shengdiaoGrid.innerHTML = "";

  pinyinData.shengdiao.forEach((tone) => {
    const button = document.createElement("button");
    button.className = "tone-button";
    button.innerHTML = `
            <div class="tone-example">${getToneDisplay(tone.tone)}</div>
            <div class="tone-name">${tone.name}</div>
        `;
    button.onclick = () => selectShengdiao(tone, button);
    elements.shengdiaoGrid.appendChild(button);
  });
}

function getToneDisplay(toneNumber) {
  // å¦‚æœå·²é€‰æ‹©éŸµæ¯ï¼Œæ˜¾ç¤ºå¯¹åº”çš„å¸¦å£°è°ƒéŸµæ¯
  if (currentSelection.yunmu) {
    return addToneMarks(currentSelection.yunmu, toneNumber);
  }

  // é»˜è®¤æ˜¾ç¤º
  const defaultExamples = {
    1: "Ä",
    2: "Ã¡",
    3: "Ç",
    4: "Ã ",
    0: "a",
  };

  return defaultExamples[toneNumber];
}

function getMainVowel(yunmu) {
  // æ ¹æ®æ‹¼éŸ³æ ‡è°ƒè§„åˆ™ç¡®å®šä¸»è¦å…ƒéŸ³ï¼ša > o > e > i > u > Ã¼
  const priority = ["a", "o", "e", "i", "u", "Ã¼"];

  for (let vowel of priority) {
    if (yunmu.includes(vowel)) {
      return vowel;
    }
  }
  return null;
}

function addToneToVowel(vowel, tone) {
  if (tone === 0) return vowel; // è½»å£°ä¸åŠ æ ‡è®°

  const toneMarks = {
    1: { a: "Ä", o: "Å", e: "Ä“", i: "Ä«", u: "Å«", Ã¼: "Ç–" },
    2: { a: "Ã¡", o: "Ã³", e: "Ã©", i: "Ã­", u: "Ãº", Ã¼: "Ç˜" },
    3: { a: "Ç", o: "Ç’", e: "Ä›", i: "Ç", u: "Ç”", Ã¼: "Çš" },
    4: { a: "Ã ", o: "Ã²", e: "Ã¨", i: "Ã¬", u: "Ã¹", Ã¼: "Çœ" },
  };

  return toneMarks[tone][vowel] || vowel;
}

function updateToneButtonsDisplay() {
  const toneButtons = document.querySelectorAll(".tone-button");
  toneButtons.forEach((button, index) => {
    const toneExample = button.querySelector(".tone-example");
    if (toneExample) {
      toneExample.textContent = getToneDisplay(
        pinyinData.shengdiao[index].tone
      );
    }
  });
}

function selectShengmu(shengmu, button) {
  // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
  document
    .querySelectorAll(".shengmu-button")
    .forEach((btn) => btn.classList.remove("selected"));

  // é€‰æ‹©æ–°çš„å£°æ¯
  button.classList.add("selected");
  currentSelection.shengmu = shengmu;
  elements.currentShengmu.textContent = shengmu;
  elements.currentShengmu.classList.add("selected");

  updatePinyinResult();
}

function selectYunmu(yunmu, button) {
  // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
  document
    .querySelectorAll(".yunmu-button")
    .forEach((btn) => btn.classList.remove("selected"));

  // é€‰æ‹©æ–°çš„éŸµæ¯
  button.classList.add("selected");
  currentSelection.yunmu = yunmu;
  elements.currentYunmu.textContent = yunmu;
  elements.currentYunmu.classList.add("selected");

  // æ›´æ–°å£°è°ƒæŒ‰é’®æ˜¾ç¤º
  updateToneButtonsDisplay();

  updatePinyinResult();
}

function selectShengdiao(tone, button) {
  // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
  document
    .querySelectorAll(".tone-button")
    .forEach((btn) => btn.classList.remove("selected"));

  // é€‰æ‹©æ–°çš„å£°è°ƒ
  button.classList.add("selected");
  currentSelection.shengdiao = tone;
  elements.currentShengdiao.textContent = tone.tone === 0 ? "è½»" : tone.tone;
  elements.currentShengdiao.classList.add("selected");

  updatePinyinResult();
}

function updatePinyinResult() {
  clearError();

  if (!currentSelection.shengmu || !currentSelection.yunmu) {
    elements.pinyinResult.textContent = "è¯·é€‰æ‹©å£°æ¯å’ŒéŸµæ¯";
    elements.playButton.disabled = true;
    return;
  }

  // æ£€æŸ¥æ‹¼éŸ³ç»„åˆæ˜¯å¦åˆæ³•
  if (!isValidCombination(currentSelection.shengmu, currentSelection.yunmu)) {
    showError(
      `å£°æ¯"${currentSelection.shengmu}"å’ŒéŸµæ¯"${currentSelection.yunmu}"ä¸èƒ½ç»„åˆï¼`
    );
    elements.pinyinResult.textContent = "âŒ æ— æ•ˆç»„åˆ";
    elements.playButton.disabled = true;

    // æ·»åŠ éœ‡åŠ¨æ•ˆæœ
    elements.pinyinResult.classList.add("shake");
    setTimeout(() => elements.pinyinResult.classList.remove("shake"), 500);
    return;
  }

  // ç”Ÿæˆå®Œæ•´çš„æ‹¼éŸ³
  let fullPinyin = currentSelection.shengmu + currentSelection.yunmu;

  // æ·»åŠ å£°è°ƒæ ‡è®°
  if (currentSelection.shengdiao) {
    fullPinyin = addToneMarks(fullPinyin, currentSelection.shengdiao.tone);
  }

  elements.pinyinResult.textContent = fullPinyin;
  elements.playButton.disabled = false;

  // æ·»åŠ æˆåŠŸæ•ˆæœ
  elements.pinyinResult.classList.add("bounce");
  setTimeout(() => elements.pinyinResult.classList.remove("bounce"), 1000);
}

// æ‹¼éŸ³ç»„åˆéªŒè¯å‡½æ•° - ç®€åŒ–ç‰ˆ
function isValidCombination(shengmu, yunmu) {
  // ç®€å•æ£€æŸ¥ï¼šç¡®ä¿ä¸åœ¨æ— æ•ˆç»„åˆåˆ—è¡¨ä¸­
  // è¿™ä¸ªå‡½æ•°å°†è¦†ç›–æ–‡ä»¶ä¸­åé¢çš„å¤æ‚ç‰ˆæœ¬
  const invalidCombinations = [
    // j, q, x åªèƒ½ä¸ i, Ã¼ å¼€å¤´çš„éŸµæ¯ç»„åˆï¼Œä¸èƒ½ä¸å…¶ä»–éŸµæ¯ç»„åˆ
    ["j", "a"],
    ["j", "o"],
    ["j", "u"],
    ["j", "ai"],
    ["j", "ao"],
    ["j", "ou"],
    ["j", "an"],
    ["j", "un"],
    ["j", "ang"],
    ["j", "ong"],
    ["q", "a"],
    ["q", "o"],
    ["q", "u"],
    ["q", "ai"],
    ["q", "ao"],
    ["q", "ou"],
    ["q", "an"],
    ["q", "un"],
    ["q", "ang"],
    ["q", "ong"],
    ["x", "a"],
    ["x", "o"],
    ["x", "u"],
    ["x", "ai"],
    ["x", "ao"],
    ["x", "ou"],
    ["x", "an"],
    ["x", "un"],
    ["x", "ang"],
    ["x", "ong"],

    // zh, ch, sh, r ä¸èƒ½ä¸ i, Ã¼ å¼€å¤´çš„éŸµæ¯ç»„åˆ
    ["zh", "i"],
    ["zh", "Ã¼"],
    ["zh", "ie"],
    ["zh", "Ã¼e"],
    ["zh", "in"],
    ["zh", "Ã¼n"],
    ["ch", "i"],
    ["ch", "Ã¼"],
    ["ch", "ie"],
    ["ch", "Ã¼e"],
    ["ch", "in"],
    ["ch", "Ã¼n"],
    ["sh", "i"],
    ["sh", "Ã¼"],
    ["sh", "ie"],
    ["sh", "Ã¼e"],
    ["sh", "in"],
    ["sh", "Ã¼n"],
    ["r", "i"],
    ["r", "Ã¼"],
    ["r", "ie"],
    ["r", "Ã¼e"],
    ["r", "in"],
    ["r", "Ã¼n"],

    // z, c, s ä¸èƒ½ä¸ Ã¼ å¼€å¤´çš„éŸµæ¯ç»„åˆ
    ["z", "Ã¼"],
    ["z", "Ã¼e"],
    ["z", "Ã¼n"],
    ["c", "Ã¼"],
    ["c", "Ã¼e"],
    ["c", "Ã¼n"],
    ["s", "Ã¼"],
    ["s", "Ã¼e"],
    ["s", "Ã¼n"],
  ];

  // æ£€æŸ¥æ˜¯å¦åœ¨æ— æ•ˆç»„åˆåˆ—è¡¨ä¸­
  if (invalidCombinations.some(([s, y]) => s === shengmu && y === yunmu)) {
    return false;
  }

  return true;
}

// æ£€æŸ¥æ˜¯å¦ä¸ºå·²çŸ¥çš„æœ‰æ•ˆæ‹¼éŸ³ç»„åˆ
function isKnownValidPinyin(pinyin) {
  // å¸¸è§çš„æœ‰æ•ˆæ‹¼éŸ³ç»„åˆåˆ—è¡¨
  const validPinyinList = [
    // å•å­—æ¯éŸµæ¯ç»„åˆ
    "ba",
    "pa",
    "ma",
    "fa",
    "da",
    "ta",
    "na",
    "la",
    "ga",
    "ka",
    "ha",
    "za",
    "ca",
    "sa",
    "zha",
    "cha",
    "sha",
    "ra",
    "bo",
    "po",
    "mo",
    "fo",
    "duo",
    "tuo",
    "nuo",
    "luo",
    "guo",
    "kuo",
    "huo",
    "zuo",
    "cuo",
    "suo",
    "zhuo",
    "chuo",
    "shuo",
    "ruo",
    "be",
    "pe",
    "me",
    "de",
    "te",
    "ne",
    "le",
    "ge",
    "ke",
    "he",
    "ze",
    "ce",
    "se",
    "zhe",
    "che",
    "she",
    "re",

    // åŒå­—æ¯éŸµæ¯ç»„åˆ
    "bai",
    "pai",
    "mai",
    "dai",
    "tai",
    "nai",
    "lai",
    "gai",
    "kai",
    "hai",
    "zai",
    "cai",
    "sai",
    "zhai",
    "chai",
    "shai",
    "bei",
    "pei",
    "mei",
    "fei",
    "dei",
    "nei",
    "lei",
    "gei",
    "kei",
    "hei",
    "zei",
    "shei",
    "bao",
    "pao",
    "mao",
    "dao",
    "tao",
    "nao",
    "lao",
    "gao",
    "kao",
    "hao",
    "zao",
    "cao",
    "sao",
    "zhao",
    "chao",
    "shao",
    "rao",
    "bou",
    "pou",
    "mou",
    "fou",
    "dou",
    "tou",
    "nou",
    "lou",
    "gou",
    "kou",
    "hou",
    "zou",
    "cou",
    "sou",
    "zhou",
    "chou",
    "shou",
    "rou",

    // é¼»éŸ³éŸµæ¯ç»„åˆ
    "ban",
    "pan",
    "man",
    "fan",
    "dan",
    "tan",
    "nan",
    "lan",
    "gan",
    "kan",
    "han",
    "zan",
    "can",
    "san",
    "zhan",
    "chan",
    "shan",
    "ran",
    "ben",
    "pen",
    "men",
    "fen",
    "den",
    "nen",
    "gen",
    "ken",
    "hen",
    "zen",
    "cen",
    "sen",
    "zhen",
    "chen",
    "shen",
    "ren",
    "bang",
    "pang",
    "mang",
    "fang",
    "dang",
    "tang",
    "nang",
    "lang",
    "gang",
    "kang",
    "hang",
    "zang",
    "cang",
    "sang",
    "zhang",
    "chang",
    "shang",
    "rang",
    "beng",
    "peng",
    "meng",
    "feng",
    "deng",
    "teng",
    "neng",
    "leng",
    "geng",
    "keng",
    "heng",
    "zeng",
    "ceng",
    "seng",
    "zheng",
    "cheng",
    "sheng",
    "reng",
    "dong",
    "tong",
    "nong",
    "long",
    "gong",
    "kong",
    "hong",
    "zong",
    "cong",
    "song",
    "zhong",
    "chong",

    // i/u/Ã¼ ç³»åˆ—
    "bi",
    "pi",
    "mi",
    "di",
    "ti",
    "ni",
    "li",
    "ji",
    "qi",
    "xi",
    "zhi",
    "chi",
    "shi",
    "ri",
    "zi",
    "ci",
    "si",
    "bu",
    "pu",
    "mu",
    "fu",
    "du",
    "tu",
    "nu",
    "lu",
    "gu",
    "ku",
    "hu",
    "zhu",
    "chu",
    "shu",
    "ru",
    "zu",
    "cu",
    "su",
    "ju",
    "qu",
    "xu",
    "yu",
    "lÃ¼",
    "nÃ¼",

    // å¤åˆéŸµæ¯
    "bie",
    "pie",
    "mie",
    "die",
    "tie",
    "nie",
    "lie",
    "jie",
    "qie",
    "xie",
    "yue",
    "diu",
    "niu",
    "liu",
    "jiu",
    "qiu",
    "xiu",
    "you",
    "bin",
    "pin",
    "min",
    "din",
    "tin",
    "nin",
    "lin",
    "jin",
    "qin",
    "xin",
    "yin",
    "bun",
    "pun",
    "mun",
    "dun",
    "tun",
    "nun",
    "lun",
    "gun",
    "kun",
    "hun",
    "zhun",
    "chun",
    "shun",
    "run",
    "zun",
    "cun",
    "sun",
    "yun",
    "jun",
    "qun",
    "xun",
    "bing",
    "ping",
    "ming",
    "ding",
    "ting",
    "ning",
    "ling",
    "jing",
    "qing",
    "xing",
    "ying",
  ];

  return validPinyinList.includes(pinyin);
}

function addToneMarks(pinyin, tone) {
  if (tone === 0) return pinyin; // è½»å£°ä¸åŠ æ ‡è®°

  // æ‰¾åˆ°ä¸»è¦å…ƒéŸ³å¹¶æ·»åŠ å£°è°ƒæ ‡è®°
  const toneMarks = {
    1: { a: "Ä", o: "Å", e: "Ä“", i: "Ä«", u: "Å«", Ã¼: "Ç–" },
    2: { a: "Ã¡", o: "Ã³", e: "Ã©", i: "Ã­", u: "Ãº", Ã¼: "Ç˜" },
    3: { a: "Ç", o: "Ç’", e: "Ä›", i: "Ç", u: "Ç”", Ã¼: "Çš" },
    4: { a: "Ã ", o: "Ã²", e: "Ã¨", i: "Ã¬", u: "Ã¹", Ã¼: "Çœ" },
  };

  // æ ‡è°ƒè§„åˆ™ï¼ša > o > e > i > u > Ã¼
  const priority = ["a", "o", "e", "i", "u", "Ã¼"];

  for (let vowel of priority) {
    if (pinyin.includes(vowel)) {
      const toneVowel = toneMarks[tone][vowel];
      if (toneVowel) {
        return pinyin.replace(vowel, toneVowel);
      }
      break;
    }
  }

  return pinyin;
}

// è·å–æ‰€æœ‰æœ‰æ•ˆçš„æ‹¼éŸ³ç»„åˆï¼ˆç”¨äºè°ƒè¯•å’ŒéªŒè¯ï¼‰
function getAllValidPinyinCombinations() {
  return Array.from(PINYIN_VALIDATION_TABLE).sort();
}

// éªŒè¯æŸä¸ªç»„åˆæ˜¯å¦å­˜åœ¨äºè¡¨ä¸­ï¼ˆè°ƒè¯•ç”¨ï¼‰
function debugValidation(shengmu, yunmu) {
  const combination = (shengmu || "") + yunmu;
  const isValid = PINYIN_VALIDATION_TABLE.has(combination);
  console.log(
    `æ£€æŸ¥ç»„åˆ: "${shengmu}" + "${yunmu}" = "${combination}" -> ${
      isValid ? "æœ‰æ•ˆ" : "æ— æ•ˆ"
    }`
  );
  return isValid;
}

// æ˜¾ç¤ºæ‰€æœ‰æœ‰æ•ˆæ‹¼éŸ³ç»„åˆï¼ˆè°ƒè¯•ç”¨ï¼‰
function showAllValidCombinations() {
  const combinations = getAllValidPinyinCombinations();
  console.log("æ‰€æœ‰æœ‰æ•ˆçš„æ‹¼éŸ³ç»„åˆ (" + combinations.length + " ä¸ª):");
  console.log(combinations.join(", "));
  return combinations;
}

// æŒ‰å£°æ¯åˆ†ç»„æ˜¾ç¤ºæœ‰æ•ˆç»„åˆ
function showCombinationsByInitial() {
  const master = [
    "",
    "b",
    "p",
    "m",
    "f",
    "d",
    "t",
    "n",
    "l",
    "g",
    "k",
    "h",
    "j",
    "q",
    "x",
    "z",
    "c",
    "s",
    "zh",
    "ch",
    "sh",
    "r",
    "y",
    "w",
  ];
  const combinations = getAllValidPinyinCombinations();

  master.forEach((initial) => {
    const initialCombinations = combinations.filter((combo) =>
      initial === ""
        ? !master.slice(1).some((m) => combo.startsWith(m))
        : combo.startsWith(initial)
    );
    if (initialCombinations.length > 0) {
      console.log(`${initial || "é›¶å£°æ¯"}:`, initialCombinations.join(", "));
    }
  });
}

// æ·»åŠ è°ƒè¯•å·¥å…·å‡½æ•°
function debugPronunciation(shengmu, yunmu, tone) {
  console.group(`ğŸ” å‘éŸ³è°ƒè¯•: ${shengmu} + ${yunmu} (ç¬¬${tone || 1}å£°)`);

  // æ£€æŸ¥æ‹¼éŸ³åˆæ³•æ€§
  const isValid = isValidCombination(shengmu, yunmu);
  console.log("æ‹¼éŸ³åˆæ³•æ€§:", isValid ? "âœ… æœ‰æ•ˆ" : "âŒ æ— æ•ˆ");

  if (isValid) {
    // æŸ¥æ‰¾æ±‰å­—
    const character = getCharacterForPronunciation(shengmu, yunmu, tone);
    console.log("æ‰¾åˆ°æ±‰å­—:", character ? `"${character}"` : "âŒ æœªæ‰¾åˆ°");

    if (character) {
      console.log("å³å°†æ’­æ”¾å‘éŸ³:", character);
      playPronunciation();
    }
  }

  console.groupEnd();
}

// ä¸ºå¼€å‘è°ƒè¯•æ·»åŠ å…¨å±€å‡½æ•°
window.debugPinyin = debugPronunciation;

// ç»‘å®šäº‹ä»¶å¤„ç†å™¨
function bindEvents() {
  // æ’­æ”¾æŒ‰é’®
  elements.playButton.onclick = playPronunciation;

  // æ¸…é™¤æŒ‰é’®
  elements.clearButton.onclick = clearSelection;

  // éšæœºæŒ‰é’®
  elements.randomButton.onclick = generateRandomCombination;
}

// æ’­æ”¾å‘éŸ³åŠŸèƒ½
function playPronunciation() {
  if (!currentSelection.shengmu || !currentSelection.yunmu) {
    showError("è¯·å…ˆé€‰æ‹©å£°æ¯å’ŒéŸµæ¯ï¼");
    return;
  }

  const tone = currentSelection.shengdiao ? currentSelection.shengdiao.tone : 1;
  const character = getCharacterForPronunciation(
    currentSelection.shengmu,
    currentSelection.yunmu,
    tone
  );

  if (character) {
    // ä½¿ç”¨TTSæ’­æ”¾å‘éŸ³
    const utterance = new SpeechSynthesisUtterance(character);
    utterance.lang = "zh-CN";
    utterance.rate = 0.8;
    utterance.pitch = 1;

    speechSynthesis.speak(utterance);
  } else {
    showError("æ‰¾ä¸åˆ°å¯¹åº”çš„æ±‰å­—è¿›è¡Œå‘éŸ³ï¼");
  }
}

// æ¸…é™¤é€‰æ‹©
function clearSelection() {
  currentSelection = {
    shengmu: null,
    yunmu: null,
    shengdiao: null,
  };

  // æ¸…é™¤UIæ˜¾ç¤º
  elements.currentShengmu.textContent = "_";
  elements.currentYunmu.textContent = "_";
  elements.currentShengdiao.textContent = "_";
  elements.pinyinResult.textContent = "è¯·é€‰æ‹©å£°æ¯å’ŒéŸµæ¯";
  elements.playButton.disabled = true;

  // æ¸…é™¤é€‰ä¸­çŠ¶æ€
  document.querySelectorAll(".selection-button.selected").forEach((btn) => {
    btn.classList.remove("selected");
  });
  document.querySelectorAll(".tone-button.selected").forEach((btn) => {
    btn.classList.remove("selected");
  });
  document.querySelectorAll(".pinyin-part.selected").forEach((part) => {
    part.classList.remove("selected");
  });

  clearError();
}

// ç”Ÿæˆéšæœºç»„åˆ
function generateRandomCombination() {
  let availableShengmu = pinyinData.shengmu;
  let availableYunmu = pinyinData.yunmu;

  let attempts = 0;
  const maxAttempts = 100;

  while (attempts < maxAttempts) {
    const randomShengmu =
      availableShengmu[Math.floor(Math.random() * availableShengmu.length)];
    const randomYunmu =
      availableYunmu[Math.floor(Math.random() * availableYunmu.length)];

    if (isValidCombination(randomShengmu, randomYunmu)) {
      // æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®
      const shengmuButtons = document.querySelectorAll(".shengmu-button");
      const yunmuButtons = document.querySelectorAll(".yunmu-button");

      let shengmuButton = null;
      let yunmuButton = null;

      // æŸ¥æ‰¾å£°æ¯æŒ‰é’®
      for (let btn of shengmuButtons) {
        if (btn.textContent === randomShengmu) {
          shengmuButton = btn;
          break;
        }
      }

      // æŸ¥æ‰¾éŸµæ¯æŒ‰é’®
      for (let btn of yunmuButtons) {
        if (btn.textContent === randomYunmu) {
          yunmuButton = btn;
          break;
        }
      }

      // æ¨¡æ‹Ÿç‚¹å‡»æŒ‰é’®
      if (shengmuButton) selectShengmu(randomShengmu, shengmuButton);
      if (yunmuButton) selectYunmu(randomYunmu, yunmuButton);

      // éšæœºé€‰æ‹©å£°è°ƒ
      const randomTone =
        pinyinData.shengdiao[
          Math.floor(Math.random() * pinyinData.shengdiao.length)
        ];
      const toneButtons = document.querySelectorAll(".tone-button");
      const toneIndex = pinyinData.shengdiao.findIndex(
        (t) => t.tone === randomTone.tone
      );
      if (toneButtons[toneIndex])
        selectShengdiao(randomTone, toneButtons[toneIndex]);

      break;
    }
    attempts++;
  }

  if (attempts >= maxAttempts) {
    showError("æ— æ³•ç”Ÿæˆæœ‰æ•ˆçš„éšæœºç»„åˆï¼");
  }
}
// é”™è¯¯æ˜¾ç¤ºå‡½æ•°
function showError(message) {
  elements.errorMessage.textContent = message;
  setTimeout(() => {
    elements.errorMessage.textContent = "";
  }, 3000);
}

function clearError() {
  elements.errorMessage.textContent = "";
}

// è·å–æ±‰å­—ç”¨äºå‘éŸ³çš„è¾…åŠ©å‡½æ•°
function getCharacterForPronunciation(shengmu, yunmu, tone) {
  const pinyinKey = shengmu + yunmu + (tone || 1);
  return pinyinCharacterMap[pinyinKey] || null;
}
